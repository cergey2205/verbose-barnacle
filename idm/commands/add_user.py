from ..objects import dp, Event
from .. import utils
from vkapi import VkApiResponseException

@dp.event_handle(dp.Methods.ADD_USER)
def add_user(event: Event) -> str:
    user = event.api('users.get', user_ids=event.obj['user_id'])[0]
    message = f"üíö –î–æ–±–∞–≤–ª—è—é [id{user['id']}|{user['first_name']} {user['last_name']}]"

    message_id = utils.new_message(event.api, event.chat.peer_id, message=message)

    try:
        event.api('messages.addChatUser', chat_id=event.chat.id, user_id=user['id'])
        message = f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å [id{user['id']}|{user['first_name']} {user['last_name']}] –≤ —á–∞—Ç–∏–∫–µ üòé"
    except VkApiResponseException as e:
        if e.error_code == 15:
            message = f"‚ùó –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å [id{user['id']}|{user['first_name']} {user['last_name']}].\n–ù–µ –≤ –º–æ–∏—Ö –¥—Ä—É–∑—å—è—Ö –∏–ª–∏ —É–∂–µ –≤ –±–µ—Å–µ–¥–µ ü§∑‚Äç‚ôÄ"
        else:
            message = f"‚ùó –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å [id{user['id']}|{user['first_name']} {user['last_name']}].\n–û—à–∏–±–∫–∞ –í–ö.\n{e.error_msg}"
    except:
        message = f"‚ùó –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å [id{user['id']}|{user['first_name']} {user['last_name']}].\n–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞." 
    utils.edit_message(event.api, event.chat.peer_id, message_id, message=message)
    return "ok"
